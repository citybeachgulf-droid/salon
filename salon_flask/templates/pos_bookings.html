<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إدارة الحجوزات</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-pink-50 font-sans">

<header class="bg-pink-200 p-4 shadow-md">
    <h1 class="text-3xl font-bold text-white text-center">إدارة الحجوزات</h1>
</header>

<main class="p-6">

  <!-- زر إضافة حجز: يظهر فقط للمحاسب والمدير -->
  {% if session.get('role') in ['accountant', 'admin'] %}
  <div class="mb-4 text-right">
    <button 
      class="bg-green-400 text-white py-2 px-4 rounded-lg hover:bg-green-500 transition"
      onclick="openBookingModal()">
      إضافة حجز جديد
    </button>
  </div>
  {% endif %}

  <!-- جدول الحجوزات -->
  <div class="overflow-x-auto bg-white rounded-lg shadow p-4">
    <table class="min-w-full text-right">
      <thead class="bg-pink-100 text-pink-700">
        <tr>
          <th class="py-2 px-4">العميل</th>
          <th class="py-2 px-4">رقم العميل</th>
          <th class="py-2 px-4">الخدمة</th>
          <th class="py-2 px-4">الموظف</th>
          <th class="py-2 px-4">التاريخ</th>
          <th class="py-2 px-4">الوقت</th>
          <th class="py-2 px-4">الحالة</th>
        </tr>
      </thead>
      <tbody>
        {% for booking in bookings %}
        <tr class="border-b hover:bg-pink-50">
          <td class="py-2 px-4">{{ booking.customer.name }}</td>
          <td class="py-2 px-4">{{ booking.customer.phone }}</td>
          <td class="py-2 px-4">{{ booking.service.name }}</td>
          <td class="py-2 px-4">{{ booking.employee.name }}</td>
          <td class="py-2 px-4">{{ booking.date.strftime('%Y-%m-%d') }}</td>
          <td class="py-2 px-4">{{ booking.time.strftime('%H:%M') }}</td>
          <td class="py-2 px-4">{{ booking.status }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="py-4 text-center text-gray-500">لا توجد حجوزات بعد</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</main>

<!-- مودال إضافة الحجز -->
<div id="bookingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 w-11/12 md:w-1/3 shadow-lg relative">
    <button onclick="closeBookingModal()" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    <h2 class="text-xl font-bold text-pink-600 mb-4">إضافة حجز جديد</h2>
    <form action="{{ url_for('main.pos_bookings') }}" method="POST" class="space-y-4">
      <div>
        <label class="block mb-1 font-semibold">اسم العميل</label>
        <input type="text" name="customer_name" class="w-full p-2 border rounded-lg" required>
      </div>
      <div>
        <label class="block mb-1 font-semibold">رقم العميل</label>
        <input type="text" name="customer_phone" class="w-full p-2 border rounded-lg" required>
      </div>
      <div>
        <label class="block mb-1 font-semibold">الخدمة</label>
        <select name="service_id" class="w-full p-2 border rounded-lg" required>
          {% for service in services %}
          <option value="{{ service.id }}">{{ service.name }} - {{ service.price }} ر.ع</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block mb-1 font-semibold">الموظف المستلم</label>
        <select name="employee_id" class="w-full p-2 border rounded-lg" required>
          {% for emp in employees %}
          <option value="{{ emp.id }}">{{ emp.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block mb-1 font-semibold">تاريخ الحجز</label>
        <input type="date" name="booking_date" id="pos_booking_date" class="w-full p-2 border rounded-lg" required>
      </div>
      <div>
        <label class="block mb-1 font-semibold">وقت الحجز</label>
        <input type="hidden" name="booking_time" id="pos_booking_time" required>
        <div class="relative">
          <button type="button" id="pos_time_toggle" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-400 flex items-center justify-between">
            <span id="pos_time_selected">اختر الوقت</span>
            <span class="text-gray-500">▼</span>
          </button>
          <div id="pos_time_menu" class="absolute right-0 mt-1 w-full bg-white border rounded-lg shadow-lg max-h-60 overflow-y-auto hidden z-20"></div>
        </div>
        <p id="pos_time_hint" class="text-sm text-gray-500 mt-1">اختر التاريخ أولاً لتحميل الأوقات المتاحة</p>
      </div>
      <button type="submit" class="w-full bg-green-400 text-white py-2 rounded-lg hover:bg-green-500 transition">تأكيد الحجز</button>
    </form>
  </div>
</div>

<script>
function openBookingModal() {
    document.getElementById('bookingModal').classList.remove('hidden');
    document.getElementById('bookingModal').classList.add('flex');
    resetPosTimePicker();
}

function closeBookingModal() {
    document.getElementById('bookingModal').classList.add('hidden');
    document.getElementById('bookingModal').classList.remove('flex');
}

// --------- Time Dropdown (POS Modal) ---------
const posTime = {
  toggle: null,
  menu: null,
  selectedText: null,
  hiddenInput: null,
  dateInput: null,
  serviceInput: null,
  isOpen: false
};

function resetPosTimePicker() {
  if (!posTime.toggle) {
    posTime.toggle = document.getElementById('pos_time_toggle');
    posTime.menu = document.getElementById('pos_time_menu');
    posTime.selectedText = document.getElementById('pos_time_selected');
    posTime.hiddenInput = document.getElementById('pos_booking_time');
    posTime.dateInput = document.getElementById('pos_booking_date');
    posTime.serviceInput = document.querySelector('select[name="service_id"]');

    posTime.toggle.addEventListener('click', () => {
      if (!posTime.menu.dataset.ready) {
        fetchPosAvailableTimes();
      }
      posTime.isOpen = !posTime.isOpen;
      posTime.menu.classList.toggle('hidden', !posTime.isOpen);
    });

    document.addEventListener('click', (e) => {
      if (!posTime.isOpen) return;
      const within = posTime.toggle.contains(e.target) || posTime.menu.contains(e.target);
      if (!within) {
        posTime.isOpen = false;
        posTime.menu.classList.add('hidden');
      }
    });

    if (posTime.dateInput) {
      posTime.dateInput.addEventListener('change', () => {
        posTime.menu.dataset.ready = '';
        posTime.hiddenInput.value = '';
        posTime.selectedText.textContent = 'اختر الوقت';
        fetchPosAvailableTimes();
      });
    }

    const serviceSelect = posTime.serviceInput;
    if (serviceSelect) {
      serviceSelect.addEventListener('change', () => {
        posTime.menu.dataset.ready = '';
        posTime.hiddenInput.value = '';
        posTime.selectedText.textContent = 'اختر الوقت';
      });
    }
  }

  posTime.menu.innerHTML = '';
  delete posTime.menu.dataset.ready;
  posTime.hiddenInput.value = '';
  posTime.selectedText.textContent = 'اختر الوقت';
  posTime.isOpen = false;
  posTime.menu.classList.add('hidden');
}

function fetchPosAvailableTimes() {
  const serviceId = posTime.serviceInput && posTime.serviceInput.value;
  const dateStr = posTime.dateInput && posTime.dateInput.value;
  const hint = document.getElementById('pos_time_hint');
  if (!serviceId || !dateStr) {
    if (hint) hint.textContent = 'اختر التاريخ أولاً لتحميل الأوقات المتاحة';
    return;
  }
  if (hint) hint.textContent = 'جاري تحميل الأوقات المتاحة...';

  fetch(`/api/available_times?service_id=${encodeURIComponent(serviceId)}&date=${encodeURIComponent(dateStr)}`)
    .then(r => r.json())
    .then(data => {
      posTime.menu.innerHTML = '';
      const times = Array.isArray(data.times) ? data.times : [];
      if (!times.length) {
        posTime.menu.innerHTML = '<div class="p-3 text-gray-500 text-center">لا توجد أوقات متاحة</div>';
      } else {
        times.forEach(t => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'w-full text-right px-4 py-2 hover:bg-pink-50 focus:bg-pink-100';
          btn.textContent = t;
          btn.addEventListener('click', () => {
            posTime.hiddenInput.value = t;
            posTime.selectedText.textContent = t;
            posTime.isOpen = false;
            posTime.menu.classList.add('hidden');
          });
          posTime.menu.appendChild(btn);
        });
      }
      if (hint) hint.textContent = 'اختر الوقت';
      posTime.menu.dataset.ready = '1';
    })
    .catch(() => {
      posTime.menu.innerHTML = '<div class="p-3 text-red-500 text-center">تعذر جلب الأوقات</div>';
      if (hint) hint.textContent = 'حاول مرة أخرى';
    });
}
</script>

</body>
</html>
